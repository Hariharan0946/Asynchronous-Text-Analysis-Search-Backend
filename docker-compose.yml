services:
  web:
    # Django application service exposing REST APIs
    build: .
    # Build image from local Dockerfile

    ports:
      - "8000:8000"
    # Expose application port for local access and testing

    env_file: .env
    # Load environment variables for configuration (secrets, flags)

    depends_on:
      - db
      - redis
    # Ensure database and broker services start before web service

    restart: unless-stopped
    # Automatically restart container unless explicitly stopped


  worker:
    # Celery worker service for background task processing
    build: .
    # Reuse same application image for consistency

    command: celery -A core worker -l info
    # Start Celery worker with Django app context

    env_file: .env
    # Share environment configuration with web service

    depends_on:
      - db
      - redis
    # Ensure required backend services are available

    restart: unless-stopped
    # Improve resilience during transient failures


  db:
    # PostgreSQL database service for persistent storage
    image: postgres:15-alpine
    # Lightweight, production-grade PostgreSQL image

    environment:
      POSTGRES_DB: codemonk
      POSTGRES_USER: codemonk
      POSTGRES_PASSWORD: codemonk
    # Database credentials and initial database name

    volumes:
      - postgres_data:/var/lib/postgresql/data
    # Persist database data across container restarts


  redis:
    # Redis service used as Celery message broker and result backend
    image: redis:7-alpine
    # Lightweight Redis image suitable for containerized environments


volumes:
  postgres_data:
    # Named volume to ensure database persistence